<!DOCTYPE html>
<html lang="pl">
<head>
   <meta charset="UTF-8">
   <title>Moje Zadania - Krzysztof</title>
   <style>
      body {
         font-family: Arial, sans-serif;
         max-width: 500px;
         margin: 20px auto;
         line-height: 1.6;
         background-color: #f4f4f4;
      }

      .container {
         background: white;
         padding: 20px;
         border-radius: 8px;
         box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      h2 {
         text-align: center;
         color: #333;
      }

      .zadanie {
         display: flex;
         justify-content: space-between;
         align-items: center;
         padding: 10px;
         border-bottom: 1px solid #ddd;
      }

      .tekst-zadania {
         cursor: pointer;
         flex-grow: 1;
      }

      .wykonane {
         text-decoration: line-through;
         color: gray;
      }

      #formularz, #loginForm {
         margin-bottom: 20px;
         display: flex;
         gap: 10px;
         flex-direction: column;
      }

      .row {
         display: flex;
         gap: 10px;
      }

      input[type="text"], input[type="password"] {
         flex-grow: 1;
         padding: 8px;
         border: 1px solid #ccc;
         border-radius: 4px;
      }

      button {
         padding: 8px 15px;
         cursor: pointer;
         border-radius: 4px;
         border: none;
         background: #28a745;
         color: white;
      }

      .btn-wyloguj {
         background: #6c757d;
         float: right;
         margin-top: -40px;
      }

      .btn-usun {
         background: #dc3545;
      }

      .btn-edycja {
         background: #ffc107;
         color: black;
      }

      #sekcjaZadan {
         display: none;
      }
      /* Ukryte przed zalogowaniem */
   </style>
</head>
<body>

   <div class="container">
      <h2>Lista Zadań</h2>

      <div id="sekcjaLogowania">
         <div id="loginForm">
            <input type="text" id="loginUsername" placeholder="Użytkownik">
            <input type="password" id="loginPassword" placeholder="Hasło">
            <button onclick="zaloguj()">Zaloguj się</button>
         </div>
      </div>

      <div id="sekcjaZadan">
         <button class="btn-wyloguj" onclick="wyloguj()">Wyloguj</button>
         <p>Zalogowano jako: <strong id="nazwaUzytkownika"></strong></p>

         <div id="formularz" class="row">
            <input type="text" id="noweZadanieTytul" placeholder="Co jest do zrobienia?">
            <button onclick="dodajZadanie()">Dodaj</button>
         </div>

         <div id="listaZadan"></div>
      </div>
   </div>

   <script>
      const API_BASE = 'https://localhost/ZadaniaApi/api/zadania';

      // --- FUNKCJE POMOCNICZE ---

      function pobierzToken() {
         return localStorage.getItem('jwt_token');
      }

      function sprawdzAutoryzacje() {
         const token = pobierzToken();
         if (token) {
            document.getElementById('sekcjaLogowania').style.display = 'none';
            document.getElementById('sekcjaZadan').style.display = 'block';
            document.getElementById('nazwaUzytkownika').innerText = localStorage.getItem('username');
            pobierzZadania();
         } else {
            document.getElementById('sekcjaLogowania').style.display = 'block';
            document.getElementById('sekcjaZadan').style.display = 'none';
         }
      }

      // --- LOGOWANIE I WYLOGOWANIE ---

      async function zaloguj() {
         const u = document.getElementById('loginUsername').value;
         const p = document.getElementById('loginPassword').value;

         // Zmieniamy ścieżkę na /api/auth/login (zgodnie z Twoim testem)
         const AUTH_URL = 'https://localhost/ZadaniaApi/api/auth/login';

         try {
            const res = await fetch(AUTH_URL, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ username: u, password: p })
            });

            if (res.ok) {
               const data = await res.json();
               // Zapisujemy token do pamięci przeglądarki
               localStorage.setItem('jwt_token', data.token);
               localStorage.setItem('username', u);
               sprawdzAutoryzacje();
            } else {
               const errorText = await res.text();
               alert("Błąd logowania: " + errorText);
            }
         } catch (e) {
            console.error(e);
            alert("Błąd połączenia z API. Sprawdź konsolę (F12).");
         }
      }

      function wyloguj() {
         localStorage.removeItem('jwt_token');
         localStorage.removeItem('username');
         location.reload(); // Odśwież stronę
      }

      // --- OPERACJE NA ZADANIACH (Z TOKENEM) ---

      async function pobierzZadania() {
         const res = await fetch(API_BASE, {
            headers: { 'Authorization': `Bearer ${pobierzToken()}` }
         });

         if (res.status === 401) return wyloguj(); // Token wygasł lub brak

         const zadania = await res.json();
         const lista = document.getElementById('listaZadan');
         lista.innerHTML = '';
         zadania.forEach(z => {
            lista.innerHTML += `
                  <div class="zadanie">
                     <span class="tekst-zadania ${z.czyWykonane ? 'wykonane' : ''}" onclick="zmienStatus(${z.id}, '${z.tytul}', ${z.czyWykonane})">
                        ${z.tytul}
                     </span>
                     <div class="akcje">
                        <button class="btn-edycja" onclick="edytujZadanie(${z.id}, '${z.tytul}', ${z.czyWykonane})">Edytuj</button>
                        <button class="btn-usun" onclick="usunZadanie(${z.id})">Usuń</button>
                     </div>
                  </div>`;
         });
      }

      async function dodajZadanie() {
         const input = document.getElementById('noweZadanieTytul');
         if (!input.value) return;

         await fetch(API_BASE, {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
               'Authorization': `Bearer ${pobierzToken()}`
            },
            body: JSON.stringify({ tytul: input.value, czyWykonane: false })
         });
         input.value = '';
         pobierzZadania();
      }

      async function usunZadanie(id) {
         if (confirm("Usunąć?")) {
            await fetch(`${API_BASE}/${id}`, {
               method: 'DELETE',
               headers: { 'Authorization': `Bearer ${pobierzToken()}` }
            });
            pobierzZadania();
         }
      }

      async function edytujZadanie(id, staryTytul, status) {
         const nowyTytul = prompt("Edytuj:", staryTytul);
         if (!nowyTytul) return;
         await fetch(`${API_BASE}/${id}`, {
            method: 'PUT',
            headers: {
               'Content-Type': 'application/json',
               'Authorization': `Bearer ${pobierzToken()}`
            },
            body: JSON.stringify({ id, tytul: nowyTytul, czyWykonane: status })
         });
         pobierzZadania();
      }

      async function zmienStatus(id, tytul, status) {
         await fetch(`${API_BASE}/${id}`, {
            method: 'PUT',
            headers: {
               'Content-Type': 'application/json',
               'Authorization': `Bearer ${pobierzToken()}`
            },
            body: JSON.stringify({ id, tytul, czyWykonane: !status })
         });
         pobierzZadania();
      }

      // Start aplikacji
      sprawdzAutoryzacje();
   </script>
</body>
</html>